services:
  # ==========================================================================
  # LocalStack - AWS Services Emulator (with Pro features)
  # ==========================================================================
  localstack:
    image: localstack/localstack-pro:latest
    container_name: chatbot-localstack
    ports:
      - "4566:4566"      # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      # Core Configuration
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}
      - SERVICES=s3,dynamodb,lambda,events,secretsmanager,opensearch
      - DEBUG=1
      - PERSISTENCE=1

      # Lambda Configuration
      - LAMBDA_EXECUTOR=docker-reuse
      - LAMBDA_DOCKER_NETWORK=chatbot-network
      - LAMBDA_REMOVE_CONTAINERS=true
      - DOCKER_HOST=unix:///var/run/docker.sock

      # AWS Configuration
      - AWS_DEFAULT_REGION=${AWS_REGION:-us-east-1}

      # Feature Flags
      - OPENSEARCH_ENDPOINT_STRATEGY=domain
      - OPENSEARCH_CUSTOM_BACKEND=http://opensearch:9200

    volumes:
      - "./localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "../lambda_functions:/lambda_functions:ro"
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # OpenSearch - For LocalStack OpenSearch backend
  # ==========================================================================
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: chatbot-opensearch
    ports:
      - "9200:9200"
      - "9600:9600"
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_SECURITY_PLUGIN=true"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - "./opensearch-data:/usr/share/opensearch/data"
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # ChromaDB - Vector Store (Alternative to OpenSearch)
  # ==========================================================================
  chromadb:
    image: chromadb/chroma:0.4.24
    container_name: chatbot-chromadb
    ports:
      - "8001:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - "./chromadb-data:/chroma/chroma"
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # PostgreSQL - Relational Database
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: chatbot-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-chatbot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chatbot123}
      POSTGRES_DB: ${POSTGRES_DB:-chatbot}
    volumes:
      - "./postgres-data:/var/lib/postgresql/data"
      - "./docker/init.sql:/docker-entrypoint-initdb.d/init.sql"
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-chatbot}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Redis - Caching & Session Store
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: chatbot-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - "./redis-data:/data"
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # API Service - RESTful API Server (FastAPI)
  # ==========================================================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: chatbot-api
    ports:
      - "8000:8000"
    environment:
      # Load all environment variables from .env
      - ENVIRONMENT=${ENVIRONMENT}
      - PROJECT_NAME=${PROJECT_NAME}
      - AWS_REGION=${AWS_REGION}
      - LOG_LEVEL=${LOG_LEVEL}

      # AWS/LocalStack
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

      # DynamoDB
      - CONVERSATIONS_TABLE=${CONVERSATIONS_TABLE}
      - USERS_TABLE=${USERS_TABLE}
      - GROUPS_TABLE=${GROUPS_TABLE}
      - PERMISSIONS_TABLE=${PERMISSIONS_TABLE}

      # S3
      - DOCUMENTS_BUCKET=${DOCUMENTS_BUCKET}

      # OpenSearch
      - OPENSEARCH_ENDPOINT=http://opensearch:9200
      - OPENSEARCH_INDEX=${OPENSEARCH_INDEX}

      # LLM
      - LLM_PROVIDER=${LLM_PROVIDER}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - GEMINI_EMBED_MODEL=${GEMINI_EMBED_MODEL}

      # Database
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # ChromaDB
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000

      # API Settings
      - APP_HOST=${APP_HOST}
      - APP_PORT=${APP_PORT}
      - DEBUG=${DEBUG}
      - API_PREFIX=${API_PREFIX}

      # Authentication
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - ENABLE_AUTHENTICATION=${ENABLE_AUTHENTICATION}

    volumes:
      - ..:/app
      - /app/.venv  # Exclude virtual environment
    depends_on:
      localstack:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    networks:
      - chatbot-network
    command: >
      sh -c "
        echo 'Waiting for services...' &&
        sleep 10 &&
        echo 'Initializing LocalStack resources...' &&
        python scripts/init_localstack.py &&
        echo 'Deploying Management Lambda functions...' &&
        python scripts/lambda/deploy_management.py &&
        echo 'Starting API server...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  chatbot-network:
    driver: bridge

volumes:
  localstack-data:
    driver: local
  opensearch-data:
    driver: local
  chromadb-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
