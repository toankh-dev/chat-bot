stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_NAME: kass-backend
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml

# Only run on splus-develop branch
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "splus-develop"

build:
  stage: build
  script:
    - echo "Building Docker image..."
    # Build production image with latest tag
    - docker build -f Dockerfile.prod -t $DOCKER_IMAGE_NAME:latest .
    # Build production image with commit SHA tag for versioning
    - docker build -f Dockerfile.prod -t $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
  only:
    - splus-develop

deploy:
  stage: deploy
  script:
    - echo "Deploying application..."
    # Stop and remove old containers
    - docker compose -f $DOCKER_COMPOSE_FILE down || true
    # Pull external service images (postgres, redis, chromadb)
    - docker compose -f $DOCKER_COMPOSE_FILE pull postgres redis chromadb || true
    # Start new containers with build
    - docker compose -f $DOCKER_COMPOSE_FILE up -d --build
    # Wait for services to be ready
    - echo "Waiting for services to be ready..."
    - sleep 20
    # Verify services are running
    - docker compose -f $DOCKER_COMPOSE_FILE ps
    # Check API health logs
    - echo "Checking API health..."
    - docker compose -f $DOCKER_COMPOSE_FILE logs api | tail -20
    # Clean up old images to save space
    - docker image prune -f
    - echo "Deployment completed successfully!"
    - echo "Application is running at http://localhost:8000"
  only:
    - splus-develop
  dependencies:
    - build

