stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_NAME: kass-backend
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml

before_script:
  - echo "Cleaning up Python cache files..."
  - sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
  - sudo find . -type f -name "*.pyc" -exec rm -f {} + 2>/dev/null || true

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "splus-develop"

build:
  stage: build
  script:
    - echo "Pre-cleanup before build..."
    - sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    - sudo find . -type f -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
    - echo "Building Docker image..."
    - docker build -f Dockerfile.prod -t $DOCKER_IMAGE_NAME:latest .
    - docker build -f Dockerfile.prod -t $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - echo "Post-cleanup after build..."
    - sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    - sudo find . -type f -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
  only:
    - splus-develop

deploy:
  stage: deploy
  script:
    - echo "Pre-cleanup before deploy..."
    - sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    - echo "Deploying application..."
    - docker compose -f $DOCKER_COMPOSE_FILE down || true
    - docker compose -f $DOCKER_COMPOSE_FILE pull postgres redis chromadb || true
    - docker compose -f $DOCKER_COMPOSE_FILE up -d --build
    - echo "Waiting for services to be ready..."
    - sleep 20
    - docker compose -f $DOCKER_COMPOSE_FILE ps
    - echo "Checking API health..."
    - docker compose -f $DOCKER_COMPOSE_FILE logs api | tail -20
    - docker image prune -f
    - echo "Post-cleanup after deploy..."
    - sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    - echo "Deployment completed successfully!"
    - echo "Application is running at http://localhost:8000"
  only:
    - splus-develop
  dependencies:
    - build